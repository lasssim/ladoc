{% extends "base.html" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ base_url }}/css/lightgallery.min.css">

    <style>
      .play-button-svg {
        width: 200px;
        height: auto;
        margin: 0 auto;
        margin-top: 10%;
        transition: 1s; 
        fill:#7c7c7c; 
        opacity: .5;
      }

      .play-button-svg:hover {
        fill: #a41d33;
        opacity: 1;
      }

    </style>

{% endblock styles %}

{% block libs %}
    {{ super() }}
    <script src="{{ base_url }}/js/lightgallery.min.js"></script>
{% endblock libs %}

{% block scripts %}
    {{ super() }}
    <script>
    var elements = document.getElementsByClassName("lightgallery");
    for(var i=0; i<elements.length; i++) {
       lightGallery(elements[i]);
    }
    </script>

    <script>

    // https://codesandbox.io/s/move-dot-along-a-curve-uvbx6?file=/src/dot.js:0-751

    class AnimationSubject {

      constructor (svg, animation_subject) {
        this.svg = svg;
        this.animation_subject = animation_subject;

        this.hide();
        
        let bbox = this.animation_subject.getBBox();
        this.offset_x = bbox.x + bbox.width/2;
        this.offset_y = bbox.y + bbox.height/2;
      }

      move_to(point) {
        this.animation_subject.setAttribute(
          "transform",
          `translate(${point.x - this.offset_x}, ${point.y - this.offset_y})`
        );
        this.show();
      }


      hide() {
        this.animation_subject.style.display = "none";
      }

      show() {
        this.animation_subject.style.display = "block";
      }

    }

    class AnimationPath {
      constructor (svg, path) {
        this.svg = svg;
        this.path = path;

        this.hide();
      }

      draw_to(u) {
        let current_length = this.path.getTotalLength()-this.path.getTotalLength()*u;
        this.path.style.strokeDasharray = this.path.getTotalLength();
        this.path.style.strokeDashoffset = current_length;
        this.show();
      }

      hide() {
        this.path.style.display = "none";
      }

      show() {
        this.path.style.display = "block";
      }


    }

    class AnimationMoveOnPath {
      constructor (svg, animation_path_element, on_finish) {
        this.svg = svg;
        this.animation_path_element = animation_path_element.querySelector("path");
        this.animation_path = new AnimationPath(svg, this.animation_path_element);
        this.settings = animation_path_element.dataset;
        this.promise = null;

        let animation_object_id = this.settings["animates_object"];
        let animation_object_element = svg.querySelector(`[data-animation_object_id="${animation_object_id}"]`);

        let animation_subject = null;
        if (this.settings["animation_clone_object"]) {
          animation_subject = this.clone_subject(animation_object_element);
        } else {
          animation_subject = animation_object_element;
        }

        this.animation_subject = new AnimationSubject(this.svg, animation_subject)
      
        this.u = 0;
        this.isAnimating = true;
        this.duration = parseInt(animation_path_element.dataset["animation_duration"]);
      }


      start() {
        return this.promise = new Promise(resolve => {
          this.u = 0;
          this.tZero = Date.now();
          requestAnimationFrame(() => this.run());
          this.promise_resolve = resolve;
        });
      }

      run() {
        if (!this.isAnimating) {
          return;
        }

        this.u += (Date.now() - this.tZero) / this.duration;
        this.tZero = Date.now();

        if (this.u < 1) {
          // Keep requesting frames, till animation is ready
          requestAnimationFrame(() => this.run());
        } else {
          this.u = 1;
          this.onFinish();
        }

        let point = this.animation_path_element.getPointAtLength(this.u * this.animation_path_element.getTotalLength());
        this.animation_subject.move_to(point);

        if (!this.settings["animation_hide_path"]) {
          this.animation_path.draw_to(this.u);
        }
      }

      onFinish() {
        console.log("finished", this);
        this.promise_resolve();
      }

      pause() {
        this.isAnimating = false;
      }

      resume() {
        this.tZero = Date.now();
        this.isAnimating = true;
        requestAnimationFrame(() => this.run());
      }

      clone_subject(animation_subject_element) {
        let new_node = animation_subject_element.cloneNode(true);
        this.svg.appendChild(new_node);
        return new_node;
      }
    }

    class SVGAnimation {
      constructor (svg, animation_elements) {
        this.svg = svg

        this.animation_sequence = Array.from(animation_elements).reduce((r, a) => {
          let animation_order = parseInt(a.dataset["animation_order"]);
          let animation_class = eval("Animation" + a.dataset["animation_type"]);
          let animation = new animation_class(svg, a);
          r[animation_order] = [...r[animation_order] || [], animation];
          return r;
        }, {});

        this.add_play_button();
      }

      run() {
        this.animate_step(Object.entries(this.animation_sequence));
      }

      animate_step(animation_sequence) {
        let current_animation_step = animation_sequence.shift();
        if (current_animation_step) {
          let current_animation_step_promises = current_animation_step[1].map(
            animation => animation.start()
          );
          
          return Promise.all(current_animation_step_promises).then(
            _ => this.animate_step(animation_sequence)
          );
        } else {
          return Promise.resolve();
        }
      }

      add_play_button() {
        var circle = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
        circle.setAttributeNS(null, "cx", 303);
        circle.setAttributeNS(null, "cy", 421);
        circle.setAttributeNS(null, "rx", 40);
        circle.setAttributeNS(null, "ry", 40);
        circle.setAttributeNS(null, "fill", "#212f37");
        circle.setAttributeNS(null, "stroke-width", 4);
        
        var arrow = document.createElementNS("http://www.w3.org/2000/svg", "path");
        arrow.setAttributeNS(null, "d", "M 288 394.34 L 328 421 L 288 447.67 Z");
        
        var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("class", "play-button-svg");

        var g_element = this.svg.appendChild(g);
        g.appendChild(circle);
        g.appendChild(arrow);

        var self = this;
        g.onclick = function() {
          self.run();
        }
      }
    }

    svgs = document.getElementsByTagName("svg");

    animatable_svgs = [];

    for (let svg of svgs) {
      animation_elements = svg.querySelectorAll('[data-animation_type]');
      if (animation_elements.length > 0) {
        svg_animation = new SVGAnimation(svg, animation_elements);
        animatable_svgs.push(svg_animation);
      }
    }

    //animatable_svgs[0].run();

    </script>
{% endblock scripts %}
